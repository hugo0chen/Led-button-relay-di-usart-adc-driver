#include "LCD.h"
#include "stdlib.h"
#include "font.h"
//#include "RS485.h"
#include "Delay.h"
#include "spi1.h"

//LCD的画笔颜色和背景色
u16 POINT_COLOR=0x0000;	//画笔颜色
u16 BACK_COLOR=0xFFFF;  //背景色

//管理LCD重要参数
_lcd_dev lcddev;


//写寄存器函数
//regval:寄存器值
void LCD_WR_REG(u16 regval)
{
    SPILCD_CS_RESET;  //LCD_CS=0
    SPILCD_RS_RESET;
    SPI_WriteByte(SPI1,regval&0x00FF);
    SPILCD_CS_SET;  //LCD_CS=1
}
//写LCD数据
//data:要写入的值
void LCD_WR_DATA(u16 data)
{
    SPILCD_CS_RESET;  //LCD_CS=0
    SPILCD_RS_SET;
    SPI_WriteByte(SPI1,data>>8);
    SPI_WriteByte(SPI1,data);
    SPILCD_CS_SET;  //LCD_CS=1
}
void LCD_WR_DATA8(u8 da)   //写8位数据
{
    SPILCD_CS_RESET;  //LCD_CS=0
    SPILCD_RS_SET;
    SPI_WriteByte(SPI1,da);
    SPILCD_CS_SET;  //LCD_CS=1
}
//写寄存器
//LCD_Reg:寄存器地址
//LCD_RegValue:要写入的数据
void LCD_WR_REG_DATA(u8 LCD_Reg, u16 LCD_RegValue)
{
    LCD_WR_REG(LCD_Reg);
    LCD_WR_DATA(LCD_RegValue);
}
//开始写GRAM
void LCD_WriteRAM_Prepare(void)
{
    LCD_WR_REG(lcddev.wramcmd);
}
//当mdk -O1时间优化时需要设置
//延时i
void opt_delay(u8 i)
{
    while (i--);
}
//LCD开启显示
void LCD_DisplayOn(void)
{

}
//LCD关闭显示
void LCD_DisplayOff(void)
{

}

//设置光标位置
//Xpos:横坐标
//Ypos:纵坐标
void LCD_SetCursor(u16 Xpos, u16 Ypos)
{
    LCD_WR_REG(lcddev.setxcmd);
    LCD_WR_DATA8(Xpos>>8);
    LCD_WR_DATA8(Xpos&0XFF);
    LCD_WR_REG(lcddev.setycmd);
    LCD_WR_DATA8(Ypos>>8);
    LCD_WR_DATA8(Ypos&0XFF);
}

//画点
//x,y:坐标
//POINT_COLOR:此点的颜色
void LCD_DrawPoint(u16 x,u16 y)
{
    LCD_SetCursor(x,y);		//设置光标位置
    LCD_WriteRAM_Prepare();	//开始写入GRAM
    LCD_WR_DATA(POINT_COLOR);
}
//初始化lcd
void LCD_Init(void)
{
    SPILCD_RST_RESET ;	//LCD_RST=0	 //SPI接口复位
    Delay_nms(20); // delay 20 ms
    SPILCD_RST_SET ;	//LCD_RST=1
    Delay_nms(20);

    lcddev.width=320;
    lcddev.height=240;
    lcddev.wramcmd=0X2C;
    lcddev.setxcmd=0X2A;
    lcddev.setycmd=0X2B;

    LCD_WR_REG(0xCB);
    LCD_WR_DATA8(0x39);
    LCD_WR_DATA8(0x2C);
    LCD_WR_DATA8(0x00);
    LCD_WR_DATA8(0x34);
    LCD_WR_DATA8(0x02);

    LCD_WR_REG(0xCF);
    LCD_WR_DATA8(0x00);
    LCD_WR_DATA8(0XC1);
    LCD_WR_DATA8(0X30);

    LCD_WR_REG(0xE8);
    LCD_WR_DATA8(0x85);
    LCD_WR_DATA8(0x00);
    LCD_WR_DATA8(0x78);

    LCD_WR_REG(0xEA);
    LCD_WR_DATA8(0x00);
    LCD_WR_DATA8(0x00);

    LCD_WR_REG(0xED);
    LCD_WR_DATA8(0x64);
    LCD_WR_DATA8(0x03);
    LCD_WR_DATA8(0X12);
    LCD_WR_DATA8(0X81);

    LCD_WR_REG(0xF7);
    LCD_WR_DATA8(0x20);

    LCD_WR_REG(0xC0);    //Power control
    LCD_WR_DATA8(0x23);   //VRH[5:0]

    LCD_WR_REG(0xC1);    //Power control
    LCD_WR_DATA8(0x10);   //SAP[2:0];BT[3:0]

    LCD_WR_REG(0xC5);    //VCM control
    LCD_WR_DATA8(0x3e); //对比度调节
    LCD_WR_DATA8(0x28);

    LCD_WR_REG(0xC7);    //VCM control2
    LCD_WR_DATA8(0x86);  //--

    LCD_WR_REG(0x36);    // Memory Access Control
    LCD_WR_DATA8(0x28); //C8	   //48 68竖屏//28 E8 横屏

    LCD_WR_REG(0X2A);
    LCD_WR_DATA8(0x00);	//start
    LCD_WR_DATA8(0x00);
    LCD_WR_DATA8(0x01);	//end
    LCD_WR_DATA8(0x3F);

    LCD_WR_REG(0X2B);
    LCD_WR_DATA8(0x00);   //start
    LCD_WR_DATA8(0x00);
    LCD_WR_DATA8(0x00);   //end
    LCD_WR_DATA8(0xEF);

    LCD_WR_REG(0x3A);
    LCD_WR_DATA8(0x55);

    LCD_WR_REG(0xB1);
    LCD_WR_DATA8(0x00);
    LCD_WR_DATA8(0x18);

    LCD_WR_REG(0xB6);    // Display Function Control
    LCD_WR_DATA8(0x08);
    LCD_WR_DATA8(0x82);
    LCD_WR_DATA8(0x27);

    LCD_WR_REG(0xF2);    // 3Gamma Function Disable
    LCD_WR_DATA8(0x00);

    LCD_WR_REG(0x26);    //Gamma curve selected
    LCD_WR_DATA8(0x01);

    LCD_WR_REG(0xE0);    //Set Gamma
    LCD_WR_DATA8(0x0F);
    LCD_WR_DATA8(0x31);
    LCD_WR_DATA8(0x2B);
    LCD_WR_DATA8(0x0C);
    LCD_WR_DATA8(0x0E);
    LCD_WR_DATA8(0x08);
    LCD_WR_DATA8(0x4E);
    LCD_WR_DATA8(0xF1);
    LCD_WR_DATA8(0x37);
    LCD_WR_DATA8(0x07);
    LCD_WR_DATA8(0x10);
    LCD_WR_DATA8(0x03);
    LCD_WR_DATA8(0x0E);
    LCD_WR_DATA8(0x09);
    LCD_WR_DATA8(0x00);

    LCD_WR_REG(0XE1);    //Set Gamma
    LCD_WR_DATA8(0x00);
    LCD_WR_DATA8(0x0E);
    LCD_WR_DATA8(0x14);
    LCD_WR_DATA8(0x03);
    LCD_WR_DATA8(0x11);
    LCD_WR_DATA8(0x07);
    LCD_WR_DATA8(0x31);
    LCD_WR_DATA8(0xC1);
    LCD_WR_DATA8(0x48);
    LCD_WR_DATA8(0x08);
    LCD_WR_DATA8(0x0F);
    LCD_WR_DATA8(0x0C);
    LCD_WR_DATA8(0x31);
    LCD_WR_DATA8(0x36);
    LCD_WR_DATA8(0x0F);

    LCD_WR_REG(0x11);    //Exit Sleep
    Delay_nms(120);

    LCD_WR_REG(0x29);    //Display on
    LCD_WR_REG(0x2c);
    LCD_Clear(WHITE);

}
//清屏函数
//color:要清屏的填充色
void LCD_Clear(u16 color)
{
    u32 index=0;
    u32 totalpoint=lcddev.width;
    totalpoint*=lcddev.height; 	//得到总点数
    LCD_SetCursor(0x00,0x0000);	//设置光标位置
    LCD_WriteRAM_Prepare();     //开始写入GRAM
    for (index=0;index<totalpoint;index++)
    {
        LCD_WR_DATA(color);
    }

}

//在指定位置显示一个汉字(16*16大小)
void showhanzi16(unsigned int x,unsigned int y,unsigned char index)
{
    unsigned char i,j,k;
    const unsigned char *temp=hanzi16;
    temp+=index*32;
    for (j=0;j<16;j++)
    {
        LCD_SetCursor(x,y+j);
        LCD_WriteRAM_Prepare();	//开始写入GRAM
        for (k=0;k<2;k++)
        {
            for (i=0;i<8;i++)
            {
                if ((*temp&(1<<i))!=0)
                {
                    LCD_WR_DATA(POINT_COLOR);
                }
                else
                {
                    LCD_WR_DATA(BACK_COLOR);
                }
            }
            temp++;
        }
    }
}
//在指定位置显示一个汉字(32*32大小)
void showhanzi32(unsigned int x,unsigned int y,unsigned char index)
{
    unsigned char i,j,k;
    const unsigned char *temp=hanzi32;
    temp+=index*128;
    for (j=0;j<32;j++)
    {
        LCD_SetCursor(x,y+j);
        LCD_WriteRAM_Prepare();	//开始写入GRAM
        for (k=0;k<4;k++)
        {
            for (i=0;i<8;i++)
            {
                if ((*temp&(1<<i))!=0)
                {
                    LCD_WR_DATA(POINT_COLOR);
                }
                else
                {
                    LCD_WR_DATA(BACK_COLOR);
                }
            }
            temp++;
        }
    }
}

//在指定位置显示一个汉字(16*16大小)
void DispHZ16(unsigned int x,unsigned int y,unsigned char index)
{
    unsigned char i,j,k,n;
    n=0;
    for (j=0;j<16;j++)
    {
        LCD_SetCursor(x,y+j);
        LCD_WriteRAM_Prepare();	//开始写入GRAM
        for (k=0;k<2;k++)
        {
            for (i=0;i<8;i++)
            {
                if ((asc1_1616[index][n]&(1<<i))!=0)
                {
                    LCD_WR_DATA(POINT_COLOR);
                }
                else
                {
                    LCD_WR_DATA(BACK_COLOR);
                }
            }
            n++;
        }
    }
}
//在指定位置显示一个字符
//x,y:起始坐标
//num:要显示的字符:" "--->"~"
//size:字体大小 12/16
//mode:叠加方式(1)还是非叠加方式(0)
void LCD_ShowChar(u16 x,u16 y,u8 num,u8 size,u8 mode)
{
    u8 temp,t1,t;
    u16 y0=y;
    u16 colortemp=POINT_COLOR;
    //设置窗口
    num=num-' ';//得到偏移后的值
    if (!mode) //非叠加方式
    {
        for (t=0;t<size;t++)
        {
            if (size==12){
                //调用1206字体
                temp=asc2_1206[num][t]; 
            }else{ 
                //调用1608字体
                temp=asc2_1608[num][t];
            }
            for (t1=0;t1<8;t1++)
            {
                if (temp&0x80)POINT_COLOR=colortemp;
                else POINT_COLOR=BACK_COLOR;
                LCD_DrawPoint(x,y);
                temp<<=1;
                y++;
                if (y>=lcddev.height){
                    //超区域了
                    POINT_COLOR=colortemp;                        
                    return;                
                }
                if ((y-y0)==size)
                {
                    y=y0;
                    x++;
                    if (x>=lcddev.width){
                        //超区域了
                        POINT_COLOR=colortemp;                            
                        return;                    
                    }
                    break;
                }
            }
        }
    }else
    {
        //叠加方式
        for (t=0;t<size;t++)
        {
            if (size==12){
                //调用1206字体
                temp=asc2_1206[num][t];
            }
            else{
                //调用1608字体
                temp=asc2_1608[num][t];		 
            }
            for (t1=0;t1<8;t1++)
            {
                if (temp&0x80)LCD_DrawPoint(x,y);
                temp<<=1;
                y++;
                if (y>=lcddev.height){ 
                    //超区域了  
                    POINT_COLOR=colortemp;        
                    return;               
                }
                if ((y-y0)==size)
                {
                    y=y0;
                    x++;
                    if (x>=lcddev.width){  
                        //超区域了     
                        POINT_COLOR=colortemp;    
                        return;                  
                    }
                    break;
                }
            }
        }
    }
    POINT_COLOR=colortemp;
}
//m^n函数
//返回值:m^n次方.
u32 LCD_Pow(u8 m,u8 n)
{
    u32 result=1;
    while (n--)result*=m;
    return result;
}
//显示数字,高位为0,则不显示
//x,y :起点坐标
//len :数字的位数
//size:字体大小
//color:颜色
//num:数值(0~4294967295);
void LCD_ShowNum(u16 x,u16 y,u32 num,u8 len,u8 size)
{
    u8 t,temp;
    u8 enshow=0;
    for (t=0;t<len;t++)
    {
        temp=(num/LCD_Pow(10,len-t-1))%10;
        if (enshow==0&&t<(len-1))
        {
            if (temp==0)
            {
                LCD_ShowChar(x+(size/2)*t,y,' ',size,0);
                continue;
            }            else enshow=1;

        }
        LCD_ShowChar(x+(size/2)*t,y,temp+'0',size,0);
    }
}
//显示数字,高位为0,还是显示
//x,y:起点坐标
//num:数值(0~999999999);
//len:长度(即要显示的位数)
//size:字体大小
//mode:
//[7]:0,不填充;1,填充0.
//[6:1]:保留
//[0]:0,非叠加显示;1,叠加显示.
void LCD_ShowxNum(u16 x,u16 y,u32 num,u8 len,u8 size,u8 mode)
{
    u8 t,temp;
    u8 enshow=0;
    for (t=0;t<len;t++)
    {
        temp=(num/LCD_Pow(10,len-t-1))%10;
        if (enshow==0&&t<(len-1))
        {
            if (temp==0)
            {
                if (mode&0X80)LCD_ShowChar(x+(size/2)*t,y,'0',size,mode&0X01);
                else LCD_ShowChar(x+(size/2)*t,y,' ',size,mode&0X01);
                continue;
            }            else enshow=1;

        }
        LCD_ShowChar(x+(size/2)*t,y,temp+'0',size,mode&0X01);
    }
}
//显示字符串
//x,y:起点坐标
//width,height:区域大小
//size:字体大小
//*p:字符串起始地址
void LCD_ShowString(u16 x,u16 y,u16 width,u16 height,u8 size,const char *p)
{
    u8 x0=x;
    width+=x;
    height+=y;
    while ((*p<='~')&&(*p>=' '))//判断是不是非法字符!
    {
        if (x>=width)        {            x=x0;            y+=size;        }
        if (y>=height)break;//退出
        LCD_ShowChar(x,y,*p,size,0);
        x+=size/2;
        p++;
    }
}

void showhz(u16 x,u16 y) //显示40*40图片
{
    u16 i,j,k;
    u16 da;
    k=0;
    for (i=0;i<130;i++)
    {
        LCD_SetCursor(x,y+i);
        LCD_WriteRAM_Prepare();     			//开始写入GRAM
        for (j=0;j<200;j++)
        {
            da=gImage_huizeit[k*2+1];
            da<<=8;
            da|=gImage_huizeit[k*2];
            LCD_WR_DATA(da);
            k++;
        }
    }    
}

void showcsh(u16 x,u16 y) //显示40*40图片
{
    u16 i,j,k;
    u16 da;
    k=0;
    for (i=0;i<150;i++)
    {
        LCD_SetCursor(x,y+i);
        LCD_WriteRAM_Prepare();     			//开始写入GRAM
        for (j=0;j<200;j++)
        {
            da=gImage_csh[k*2+1];
            da<<=8;
            da|=gImage_csh[k*2];
            LCD_WR_DATA(da);
            k++;
        }
    }    
}



